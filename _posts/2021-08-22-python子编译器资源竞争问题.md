---
published: true
layout: post
title: bpo-37224 python子编译器资源竞争问题
category: python
tags:
  - python
time: '2021.08.22 15:47:00'
excerpt: null
---
cpython MR门禁中偶现的一个失败用例问题修复过程记录 

<!--more-->

## 问题背景介绍
这个问题是cpython项目门禁中发现的一个问题，具体的表现就是子编译器相关的两个用例（`test_still_running`, `test_already_running`，[用例代码详情](https://github.com/python/cpython/blob/main/Lib/test/test__xxsubinterpreters.py#L843-L846)）会高概率出现失败，尤其是并行测试数量多于300时，基本在10小时内就能再次捕捉到相关错误。[问题单详情](https://bugs.python.org/issue37224)

此问题可以用`./python -m test test__xxsubinterpreters -v -F -j300`来执行并捕捉相关错误。
错误输出日志为：
```python
test_already_running (test.test__xxsubinterpreters.RunStringTests) ... In interp_create, the current state is: 0x10718f0
In interp_list_all, the current state is: 0x10718f0
Before interp runs, the current state is: 0x10718f0这里表明_running中的interp.run未执行，实际是在后面执行
After interp runs, the current state is: 0x1189fc0
spam
In interp_list_all, the current state is: 0x10718f0
FAIL

======================================================================
FAIL: test_already_running (test.test__xxsubinterpreters.RunStringTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/home/shihai/cpython/Lib/test/test__xxsubinterpreters.py", line 834, in test_already_running
    with self.assertRaises(RuntimeError):
AssertionError: RuntimeError not raised

----------------------------------------------------------------------

Ran 123 tests in 71.761s

FAILED (failures=1, skipped=6)
Warning -- Uncaught thread exception: RuntimeError
Exception in thread Thread-8 (run):
Traceback (most recent call last):
  File "/home/shihai/cpython/Lib/threading.py", line 1009, in _bootstrap_inner
    self.run()
    ^^^^^^^^^^
  File "/home/shihai/cpython/Lib/threading.py", line 946, in run
    self._target(*self._args, **self._kwargs)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/shihai/cpython/Lib/test/test__xxsubinterpreters.py", line 48, in run
    interpreters.run_string(interp, dedent(f"""
RuntimeError: unrecognized interpreter ID 60
test test__xxsubinterpreters failed
```

### 定位过程梳理
1.线程未及时获取GIL锁导致
pass
