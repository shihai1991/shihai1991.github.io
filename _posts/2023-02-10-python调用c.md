---
layout: post
title: Python调用Golang
category: python
catalog: true
published: true
tags:
  - python
  - golang
  - c
time: '2023.02.10 10:16:00'
---
> 记一个工作中遇到的问题，由于要给C、Java、Go、Python提供客户端，客户端的核心逻辑实现语言是Go，所以Python客户端最快的实现方式是直接封装Go语言逻辑，而且因为业务需要，还要提供Python3/2两个版本，先有Python3版本，后有Python2版本，因此还需要考虑在Python2上执行Python3代码的兼容性问题。
> 主要的解决思路是Go语言和Python语言都对底层C语言的支持粒度较好，那就通过C语言作为`中间语言`，将Go语言和Python语言桥接在一起。

# 一、Go语言编译
考虑如下Go语言代码，定义了四个函数，`func main()`函数是必须的，否则会提示一个错误：`runtime.main_main·f: function main is undeclared in the main package`。将此文件保存至`exports.go`中，下文会继续使用到。
```go
package main

import "C"
import "fmt"

//export Hello
func Hello() {
        fmt.Println("Hi!")
}

//export Say
func Say(content string) {
        fmt.Println("I saied:", content)
}

//export Greet
func Greet(name string) string {
        return fmt.Sprintln("Nice to meet you, ", name)
}

func main() {
        Hello()
}
```
这里的Go代码用了2处写Go代码不太常用的点：
1. 导入`C`模块：启用CGO特性，用于Go语言能调用C语言函数库；
2. 使用`export`注释：将相关函数导出到`*.h`头文件中。

## 1.1 构建静态链接
执行如下go语言构建命令后，你会在你的文件目录中发现多了两个文件：`exports.a`，`exports.h`。这两个文件就是编译构建`exports.go`文件得到的静态文件和头文件。
```shell
go build -buildmode=c-archive exports.go
```
在`exports.h`文件中，你会发现你定义的三个函数，如下所示：
```
#ifdef __cplusplus
extern "C" {
#endif

extern void Hello();
extern void Say(GoString content);
extern GoString Greet(GoString name);

#ifdef __cplusplus
}
#endif
```

## 1.2 构建动态链接
执行如下命令即可以编译出静态链接库，在你的构建目录中会多出两个文件：`exports.h`，`exports.so`。
```
go build --buildmode=c-shared -o exports.so exports.go
```

# 二、Python语言调用链接库
Pythong中的`ctypes`模块只提供了调用动态链接库的功能，所以想用Python加载静态链接的同学可以参考附录一进行扩展阅读。

## 2.1 通过ctypes调用链接库

## 2.2 Python2上执行Python3代码兼容问题

# 三、参考附录
1.[在Python中调用Go](https://zhuanlan.zhihu.com/p/518374146)
2.[Go build模式之c-archive，c-shared，linkshared](https://davidchan0519.github.io/2019/04/05/go-buildmode-c/)
3.[Go CGO](https://chai2010.cn/advanced-go-programming-book/ch2-cgo/ch2-02-basic.html)
4.[Python Ctypes](https://docs.python.org/3/library/ctypes.html?highlight=ctypes)
5.[Go语言之父：热爱冒险，发明过航天望远镜，想用Go语言解放程序员！](https://zhuanlan.zhihu.com/p/133955040)